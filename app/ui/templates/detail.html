{% extends "base.html" %}
{% block title %}Receipt #{{ receipt.id }} - Email Receipts{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Receipt #{{ receipt.id }}
        <span class="badge badge-{{ receipt.status.value }}">{{ receipt.status.value.replace('_',' ') }}</span>
    </h2>
    <div>
        <a href="/ui/receipts" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
        <button class="btn btn-warning btn-sm" onclick="reprocess({{ receipt.id }})">üîÑ Reprocess</button>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">Email Details</div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Subject</dt>
                    <dd class="col-sm-8">{{ receipt.subject or '‚Äî' }}</dd>
                    <dt class="col-sm-4">From</dt>
                    <dd class="col-sm-8">{{ receipt.sender or '‚Äî' }}</dd>
                    <dt class="col-sm-4">Received</dt>
                    <dd class="col-sm-8">{{ receipt.received_at or '‚Äî' }}</dd>
                    <dt class="col-sm-4">Processed At</dt>
                    <dd class="col-sm-8">{% if receipt.processed_at %}{{ receipt.processed_at.strftime('%Y-%m-%d %H:%M UTC') }}{% else %}<span class="text-muted">Not yet processed</span>{% endif %}</dd>
                    <dt class="col-sm-4">Message ID</dt>
                    <dd class="col-sm-8"><code>{{ receipt.gmail_message_id }}</code></dd>
                </dl>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Extracted Data</span>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#editForm" id="editToggleBtn">‚úèÔ∏è Edit</button>
            </div>
            <div class="card-body">
                <!-- View mode -->
                <div id="extractionView">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Merchant</dt>
                        <dd class="col-sm-8" id="view-merchant">{{ receipt.merchant or '‚Äî' }}</dd>
                        <dt class="col-sm-4">Date</dt>
                        <dd class="col-sm-8" id="view-purchase-date">{{ receipt.purchase_date or '‚Äî' }}</dd>
                        <dt class="col-sm-4">Amount</dt>
                        <dd class="col-sm-8" id="view-amount">{% if receipt.amount is not none %}{{ "%.2f"|format(receipt.amount) }} {{ receipt.currency }}{% else %}‚Äî{% endif %}</dd>
                        <dt class="col-sm-4">Card Last4</dt>
                        <dd class="col-sm-8" id="view-card-last4">{{ receipt.card_last4_seen or '‚Äî' }}</dd>
                        <dt class="col-sm-4">Network</dt>
                        <dd class="col-sm-8"><small class="text-muted">{{ receipt.card_network_or_issuer or '‚Äî' }}</small></dd>
                        <dt class="col-sm-4">Card</dt>
                        <dd class="col-sm-8">{% if receipt.physical_card %}<strong>{{ receipt.physical_card.display_name }}</strong>{% if receipt.physical_card.network %} <small class="text-muted">({{ receipt.physical_card.network }})</small>{% endif %}{% else %}‚Äî{% endif %}</dd>
                        <dt class="col-sm-4">Source</dt>
                        <dd class="col-sm-8">{{ receipt.source_type or '‚Äî' }}</dd>
                        <dt class="col-sm-4">Confidence</dt>
                        <dd class="col-sm-8">{% if receipt.confidence is not none %}{{ "%.0f"|format(receipt.confidence * 100) }}%{% else %}‚Äî{% endif %}</dd>
                        <dt class="col-sm-4">Notes</dt>
                        <dd class="col-sm-8"><small>{{ receipt.extraction_notes or '‚Äî' }}</small></dd>
                    </dl>
                </div>
                <!-- Edit mode (collapsible) -->
                <div class="collapse mt-3" id="editForm">
                    <form onsubmit="saveExtraction(event, {{ receipt.id }})">
                        <div class="mb-2">
                            <label class="form-label small fw-bold">Merchant</label>
                            <input type="text" name="merchant" class="form-control form-control-sm" value="{{ receipt.merchant or '' }}">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small fw-bold">Purchase Date</label>
                            <input type="date" name="purchase_date" class="form-control form-control-sm" value="{{ receipt.purchase_date or '' }}">
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col">
                                <label class="form-label small fw-bold">Amount</label>
                                <input type="number" step="0.01" name="amount" class="form-control form-control-sm" value="{{ receipt.amount or '' }}">
                            </div>
                            <div class="col">
                                <label class="form-label small fw-bold">Currency</label>
                                <input type="text" name="currency" class="form-control form-control-sm" value="{{ receipt.currency or 'USD' }}" maxlength="10">
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small fw-bold">Card Last4</label>
                            <input type="text" name="card_last4_seen" class="form-control form-control-sm" value="{{ receipt.card_last4_seen or '' }}" maxlength="10">
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">Save</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="bootstrap.Collapse.getInstance(document.getElementById('editForm')).hide()">Cancel</button>
                        </div>
                    </form>
                    <div id="edit-result" class="mt-2 small"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if receipt.drive_file_id %}
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>üìÑ Receipt PDF</span>
        <a href="https://drive.google.com/file/d/{{ receipt.drive_file_id }}/view" target="_blank" class="btn btn-sm btn-outline-secondary">Open in Drive ‚Üó</a>
    </div>
    <div class="card-body p-0" style="position:relative;min-height:60px">
        <div id="pdf-loading" class="d-flex align-items-center justify-content-center py-4 text-muted"
             style="position:absolute;inset:0;background:#f8f9fa;z-index:1">
            <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
            Loading preview‚Ä¶
        </div>
        <div id="pdf-error" class="d-none p-3 text-center text-muted">
            <p>Preview not available. <a href="https://drive.google.com/file/d/{{ receipt.drive_file_id }}/view" target="_blank">Open in Drive ‚Üó</a> to view the file.</p>
        </div>
        <iframe
            id="pdf-preview-frame"
            src="https://drive.google.com/file/d/{{ receipt.drive_file_id }}/preview"
            width="100%"
            height="500"
            allow="autoplay"
            style="border:0;display:block"
            title="Receipt PDF Preview"
            onload="document.getElementById('pdf-loading').style.display='none'"
            onerror="document.getElementById('pdf-loading').style.display='none';document.getElementById('pdf-error').classList.remove('d-none');document.getElementById('pdf-preview-frame').style.display='none'">
        </iframe>
    </div>
</div>
{% else %}
<div class="card mb-3 border-secondary">
    <div class="card-header text-muted">üìÑ Receipt PDF</div>
    <div class="card-body">
        {% if receipt.drive_path %}
        <p class="mb-2"><strong>Drive path:</strong> <code>{{ receipt.drive_path }}</code></p>
        <p class="text-muted small mb-2">A Drive file ID is not recorded for this receipt ‚Äî the file may not have been uploaded yet, or the upload may have failed.</p>
        {% else %}
        <p class="text-muted small mb-2">No PDF is stored for this receipt. This can happen when Drive is not connected or no PDF attachment was found in the original email.</p>
        {% endif %}
        <p class="mb-0"><strong>Status:</strong> <span class="badge badge-{{ receipt.status.value }}">{{ receipt.status.value.replace('_',' ') }}</span>
        ‚Äî <button class="btn btn-warning btn-sm" onclick="reprocess({{ receipt.id }})">üîÑ Reprocess to retry upload</button></p>
    </div>
</div>
{% endif %}

{% if receipt.attachment_logs %}
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Attachment Decisions</span>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-secondary small">Latest run</span>
            {% if has_prior_attachment_runs %}
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#allAttachmentRuns">Show all runs</button>
            {% endif %}
        </div>
    </div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead class="table-light">
                <tr><th>Filename</th><th>Score</th><th>Decision</th><th>Reason</th></tr>
            </thead>
            <tbody>
                {% for log in latest_attachment_logs %}
                <tr>
                    <td>{{ log.filename }}</td>
                    <td>{{ log.score }}</td>
                    <td><span class="badge {% if log.decision == 'selected' %}bg-success{% else %}bg-secondary{% endif %}">{{ log.decision }}</span></td>
                    <td><small>{{ log.reason }}</small></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if has_prior_attachment_runs %}
        <div class="collapse" id="allAttachmentRuns">
            <div class="card-header bg-light small text-muted">All scoring runs (oldest first)</div>
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr><th>Filename</th><th>Score</th><th>Decision</th><th>Reason</th><th>Run time</th></tr>
                </thead>
                <tbody>
                    {% for log in receipt.attachment_logs | sort(attribute='created_at') %}
                    <tr>
                        <td>{{ log.filename }}</td>
                        <td>{{ log.score }}</td>
                        <td><span class="badge {% if log.decision == 'selected' %}bg-success{% else %}bg-secondary{% endif %}">{{ log.decision }}</span></td>
                        <td><small>{{ log.reason }}</small></td>
                        <td><small class="text-muted">{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if receipt.status.value == 'needs_review' %}
<div class="card border-warning mb-3">
    <div class="card-header bg-warning">‚ö†Ô∏è Needs Review - Assign Card</div>
    <div class="card-body">
        <form onsubmit="resolveCard(event, {{ receipt.id }})">
            <div class="row g-2 align-items-end">
                <div class="col-auto">
                    <label class="form-label">Assign to Card</label>
                    <select name="card_id" class="form-select">
                        <option value="">‚Äî Select card ‚Äî</option>
                        {% for card in cards %}
                        <option value="{{ card.id }}"><strong>{{ card.display_name }}</strong>{% if card.last4 %} (****{{ card.last4 }}){% endif %}{% if card.network %} ‚Äî <small>{{ card.network }}</small>{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-warning">Assign & Mark Processed</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}

<div id="action-result" class="mt-2"></div>
{% endblock %}
