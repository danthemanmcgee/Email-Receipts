{% extends "base.html" %}
{% block title %}Settings â€” Email Receipts{% endblock %}

{% block content %}
<!-- Google Picker API -->
<script src="https://apis.google.com/js/api.js" async defer></script>

<div class="row mb-3">
  <div class="col">
    <h2>Google Integrations</h2>
    <p class="text-muted">Gmail and Google Drive may be connected to <strong>different</strong> Google accounts.</p>
  </div>
</div>

{% if accounts_differ %}
<div class="alert alert-info d-flex align-items-center" role="alert">
  <svg class="bi flex-shrink-0 me-2" width="20" height="20" fill="currentColor" aria-hidden="true">
    <use xlink:href="#info-circle-fill"/>
  </svg>
  <div>
    <strong>Informational:</strong> Gmail is connected as
    <strong>{{ gmail_conn.google_account_email }}</strong> and Drive as
    <strong>{{ drive_conn.google_account_email }}</strong>.
    This is intentional if you forward emails from one account and store files in another.
  </div>
</div>
{% endif %}

<div class="row g-4">

  <!-- Gmail Connection Card -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ğŸ“¬</span>
        <strong>Gmail Connection</strong>
        {% if gmail_conn %}
          <span class="badge bg-success ms-auto">Connected</span>
        {% else %}
          <span class="badge bg-secondary ms-auto">Not connected</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if gmail_conn %}
          <p class="mb-1"><strong>Account:</strong> {{ gmail_conn.google_account_email or "Unknown" }}</p>
          <p class="mb-1 text-muted small">
            Connected: {{ gmail_conn.connected_at.strftime("%Y-%m-%d %H:%M UTC") if gmail_conn.connected_at else "â€”" }}
          </p>
          <p class="mb-0 text-muted small">
            Scopes: gmail.readonly, gmail.modify
          </p>
        {% else %}
          <p class="text-muted">No Gmail account connected. Connect one to start polling for new receipt emails.</p>
        {% endif %}
      </div>
      <div class="card-footer">
        <a href="/auth/google/gmail/start" class="btn btn-primary btn-sm">
          {% if gmail_conn %}ğŸ”„ Reconnect Gmail{% else %}ğŸ”— Connect Gmail{% endif %}
        </a>
      </div>
    </div>
  </div>

  <!-- Drive Connection Card -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ğŸ“</span>
        <strong>Google Drive Connection</strong>
        {% if drive_conn %}
          <span class="badge bg-success ms-auto">Connected</span>
        {% else %}
          <span class="badge bg-secondary ms-auto">Not connected</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if drive_conn %}
          <p class="mb-1"><strong>Account:</strong> {{ drive_conn.google_account_email or "Unknown" }}</p>
          <p class="mb-1 text-muted small">
            Connected: {{ drive_conn.connected_at.strftime("%Y-%m-%d %H:%M UTC") if drive_conn.connected_at else "â€”" }}
          </p>
          <p class="mb-0 text-muted small">
            Scopes: drive.file, drive.readonly
          </p>
        {% else %}
          <p class="text-muted">No Drive account connected. Receipts without a Drive connection will be placed in the needs-review queue.</p>
        {% endif %}
      </div>
      <div class="card-footer">
        <a href="/auth/google/drive/start" class="btn btn-primary btn-sm">
          {% if drive_conn %}ğŸ”„ Reconnect Drive{% else %}ğŸ”— Connect Drive{% endif %}
        </a>
      </div>
    </div>
  </div>

</div>

<!-- Drive Folder Setting -->
<div class="row g-4 mt-2">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ğŸ—‚ï¸</span>
        <strong>Google Drive Root Folder</strong>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-2">
          Receipts are saved under this folder in Google Drive. Subfolders are created automatically
          per card, year, and month.
        </p>
        <form id="driveFolderForm">
          <input type="hidden" id="driveFolderIdInput" value="{{ drive_root_folder_id }}" />
          <div class="input-group">
            <input
              type="text"
              id="driveFolderInput"
              class="form-control"
              value="{{ drive_root_folder }}"
              placeholder="e.g. Receipts"
              required
            />
            {% if drive_conn %}
            <button class="btn btn-outline-secondary" type="button" id="browseFolderBtn" title="Browse Drive folders">
              ğŸ“‚ Browse
            </button>
            {% endif %}
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
        <div id="driveFolderMsg" class="mt-2 small"></div>
      </div>
    </div>
  </div>
</div>

<!-- Card Management -->
<div class="row g-4 mt-2">
  <div class="col-md-10">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ğŸ’³</span>
        <strong>Card Management</strong>
        <span class="badge bg-secondary ms-auto" id="cardCountBadge">{{ cards|length }} cards</span>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">
          Add physical cards and their virtual card aliases. Card <strong>nicknames</strong> are the primary
          identifier shown throughout the app. The card network is optional and used only as secondary information.
        </p>

        <!-- Add card form -->
        <form id="addCardForm" class="mb-3">
          <div class="row g-2 align-items-end">
            <div class="col">
              <label class="form-label small fw-bold">Nickname <span class="text-danger">*</span></label>
              <input type="text" id="newCardName" class="form-control form-control-sm" placeholder="e.g. Chase Sapphire" required>
            </div>
            <div class="col-auto">
              <label class="form-label small fw-bold">Last 4 digits</label>
              <input type="text" id="newCardLast4" class="form-control form-control-sm" placeholder="1234" maxlength="10" pattern="\d{4}">
            </div>
            <div class="col-auto">
              <label class="form-label small fw-bold">Network <small class="text-muted">(optional)</small></label>
              <input type="text" id="newCardNetwork" class="form-control form-control-sm" placeholder="Visa" maxlength="50">
            </div>
            <div class="col-auto">
              <button class="btn btn-success btn-sm" type="submit">Add Card</button>
            </div>
          </div>
        </form>
        <div id="addCardMsg" class="mb-2 small"></div>

        <!-- Cards list -->
        <div id="cardsList">
          {% for card in cards %}
          <div class="card mb-2 card-entry" id="card-entry-{{ card.id }}">
            <div class="card-body py-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong id="card-name-{{ card.id }}">{{ card.display_name }}</strong>
                  {% if card.last4 %}<span class="text-muted ms-2">****{{ card.last4 }}</span>{% endif %}
                  {% if card.network %}<span class="badge bg-light text-dark ms-2 small">{{ card.network }}</span>{% endif %}
                </div>
                <div class="d-flex gap-1">
                  <a href="/ui/cards/{{ card.id }}/statements" class="btn btn-outline-info btn-sm" title="View statements & reconcile">ğŸ“Š</a>
                  <button class="btn btn-outline-secondary btn-sm" onclick="toggleEditCard({{ card.id }})">âœï¸</button>
                  <button class="btn btn-outline-danger btn-sm" onclick="deleteCard({{ card.id }})">ğŸ—‘ï¸</button>
                </div>
              </div>
              <!-- Edit card inline form (hidden by default) -->
              <div id="edit-card-{{ card.id }}" class="mt-2" style="display:none">
                <form onsubmit="saveCard(event, {{ card.id }})">
                  <div class="row g-2 align-items-end">
                    <div class="col">
                      <input type="text" name="display_name" class="form-control form-control-sm" value="{{ card.display_name }}" placeholder="Nickname" required>
                    </div>
                    <div class="col-auto">
                      <input type="text" name="last4" class="form-control form-control-sm" value="{{ card.last4 or '' }}" placeholder="Last 4" maxlength="10">
                    </div>
                    <div class="col-auto">
                      <input type="text" name="network" class="form-control form-control-sm" value="{{ card.network or '' }}" placeholder="Network" maxlength="50">
                    </div>
                    <div class="col-auto">
                      <button type="submit" class="btn btn-primary btn-sm">Save</button>
                      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleEditCard({{ card.id }})">Cancel</button>
                    </div>
                  </div>
                </form>
              </div>
              <!-- Aliases -->
              {% if card.aliases %}
              <div class="mt-2">
                <small class="text-muted">Virtual aliases:</small>
                <ul class="list-unstyled mb-0 ms-2" id="aliases-{{ card.id }}">
                  {% for alias in card.aliases %}
                  <li class="d-flex align-items-center gap-2" id="alias-{{ alias.id }}">
                    <code>****{{ alias.alias_last4 }}</code>
                    {% if alias.notes %}<small class="text-muted">{{ alias.notes }}</small>{% endif %}
                    <button class="btn btn-link btn-sm text-danger p-0" onclick="deleteAlias({{ card.id }}, {{ alias.id }})">âœ•</button>
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% else %}
              <ul class="list-unstyled mb-0 ms-2" id="aliases-{{ card.id }}"></ul>
              {% endif %}
              <!-- Add alias form -->
              <div class="mt-2">
                <form onsubmit="addAlias(event, {{ card.id }})" class="d-flex gap-2 align-items-end">
                  <input type="text" name="alias_last4" class="form-control form-control-sm" placeholder="Virtual last4" maxlength="10" pattern="\d{4}" required style="width:120px">
                  <input type="text" name="notes" class="form-control form-control-sm" placeholder="Notes (optional)" style="width:180px">
                  <button type="submit" class="btn btn-outline-secondary btn-sm">+ Alias</button>
                </form>
              </div>
            </div>
          </div>
          {% else %}
          <p class="text-muted small" id="noCardsMsg">No cards configured yet.</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>


<div class="row g-4 mt-2">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <span>âœ‰ï¸</span>
        <strong>Allowed Senders</strong>
        <span class="badge bg-secondary ms-auto">{{ allowed_senders|length }} configured</span>
      </div>
      <div class="card-body" id="sendersCardBody"> Emails from other senders will be
          <strong>archived</strong> (moved out of inbox) automatically.
          Leave this list empty to accept receipts from <em>any</em> sender.
        </p>

        <!-- Add sender form -->
        <form id="addSenderForm" class="mb-3">
          <div class="input-group">
            <input
              type="email"
              id="newSenderEmail"
              class="form-control"
              placeholder="receipts@store.com"
              required
            />
            <button class="btn btn-success" type="submit">Add</button>
          </div>
        </form>
        <div id="addSenderMsg" class="mb-2 small"></div>

        <!-- Existing senders list -->
        {% if allowed_senders %}
        <ul class="list-group" id="sendersList">
          {% for sender in allowed_senders %}
          <li class="list-group-item d-flex justify-content-between align-items-center" id="sender-{{ sender.id }}">
            <span>{{ sender.email }}</span>
            <button
              class="btn btn-outline-danger btn-sm"
              onclick="deleteSender({{ sender.id }})"
            >Remove</button>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small" id="noSendersMsg">No allowed senders configured â€” all senders are accepted.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
const googleApiKey = {{ google_api_key | tojson }};
const googleClientId = {{ google_client_id | tojson }};

// Drive folder form
document.getElementById('driveFolderForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const folder = document.getElementById('driveFolderInput').value.trim();
  const folderId = document.getElementById('driveFolderIdInput').value.trim();
  const msg = document.getElementById('driveFolderMsg');
  try {
    const resp = await fetch('/settings/app', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({drive_root_folder: folder, drive_root_folder_id: folderId}),
    });
    if (resp.ok) {
      const data = await resp.json();
      document.getElementById('driveFolderInput').value = data.drive_root_folder;
      document.getElementById('driveFolderIdInput').value = data.drive_root_folder_id;
      msg.className = 'mt-2 small text-success';
      msg.textContent = 'âœ“ Saved successfully.';
    } else {
      const err = await resp.json();
      msg.className = 'mt-2 small text-danger';
      msg.textContent = 'âœ— ' + (err.detail || 'Save failed.');
    }
  } catch (ex) {
    msg.className = 'mt-2 small text-danger';
    msg.textContent = 'âœ— Request failed: ' + ex;
  }
});

// â”€â”€ Google Drive Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function drivePickerCallback(data) {
  if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
    const doc = data[google.picker.Response.DOCUMENTS][0];
    document.getElementById('driveFolderInput').value = doc[google.picker.Document.NAME];
    document.getElementById('driveFolderIdInput').value = doc[google.picker.Document.ID];
    const msg = document.getElementById('driveFolderMsg');
    msg.className = 'mt-2 small text-info';
    msg.textContent = 'ğŸ“‚ Folder selected â€” click Save to apply.';
  }
}

function openDrivePicker(accessToken) {
  gapi.load('picker', function() {
    const view = new google.picker.DocsView()
      .setIncludeFolders(true)
      .setSelectFolderEnabled(true)
      .setMimeTypes('application/vnd.google-apps.folder');

    const pickerBuilder = new google.picker.PickerBuilder()
      .addView(view)
      .setOAuthToken(accessToken)
      .setCallback(drivePickerCallback)
      .setTitle('Select a Google Drive folder for receipts');

    if (googleApiKey) {
      pickerBuilder.setDeveloperKey(googleApiKey);
    }

    pickerBuilder.build().setVisible(true);
  });
}

const browseFolderBtn = document.getElementById('browseFolderBtn');
if (browseFolderBtn) {
  browseFolderBtn.addEventListener('click', async function() {
    const msg = document.getElementById('driveFolderMsg');
    try {
      const resp = await fetch('/settings/drive-token');
      if (!resp.ok) {
        msg.className = 'mt-2 small text-danger';
        msg.textContent = 'âœ— Google Drive is not connected.';
        return;
      }
      const data = await resp.json();
      openDrivePicker(data.access_token);
    } catch (ex) {
      msg.className = 'mt-2 small text-danger';
      msg.textContent = 'âœ— Failed to open picker: ' + ex;
    }
  });
}

// Add allowed sender
document.getElementById('addSenderForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const email = document.getElementById('newSenderEmail').value.trim();
  const msg = document.getElementById('addSenderMsg');
  try {
    const resp = await fetch('/settings/allowed-senders', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email: email}),
    });
    if (resp.ok) {
      const data = await resp.json();
      document.getElementById('newSenderEmail').value = '';
      msg.className = 'mb-2 small text-success';
      msg.textContent = 'âœ“ Added ' + data.email;
      addSenderToList(data.id, data.email);
    } else {
      const err = await resp.json();
      msg.className = 'mb-2 small text-danger';
      msg.textContent = 'âœ— ' + (err.detail || 'Add failed.');
    }
  } catch (ex) {
    msg.className = 'mb-2 small text-danger';
    msg.textContent = 'âœ— Request failed: ' + ex;
  }
});

function addSenderToList(id, email) {
  const noMsg = document.getElementById('noSendersMsg');
  if (noMsg) noMsg.remove();

  let list = document.getElementById('sendersList');
  if (!list) {
    list = document.createElement('ul');
    list.className = 'list-group';
    list.id = 'sendersList';
    // Insert after addSenderMsg to maintain template layout order
    const msgEl = document.getElementById('addSenderMsg');
    msgEl.insertAdjacentElement('afterend', list);
  }
  const li = document.createElement('li');
  li.className = 'list-group-item d-flex justify-content-between align-items-center';
  li.id = 'sender-' + id;
  li.innerHTML = '<span>' + email + '</span>' +
    '<button class="btn btn-outline-danger btn-sm" onclick="deleteSender(' + id + ')">Remove</button>';
  list.appendChild(li);
}

async function deleteSender(id) {
  const resp = await fetch('/settings/allowed-senders/' + id, {method: 'DELETE'});
  if (resp.ok || resp.status === 204) {
    const el = document.getElementById('sender-' + id);
    if (el) el.remove();
    const list = document.getElementById('sendersList');
    if (list && list.children.length === 0) {
      list.remove();
      // Use the stable card-body id to append the 'no senders' message
      const cardBody = document.getElementById('sendersCardBody');
      const p = document.createElement('p');
      p.className = 'text-muted small';
      p.id = 'noSendersMsg';
      p.textContent = 'No allowed senders configured â€” all senders are accepted.';
      cardBody.appendChild(p);
    }
  }
}

// â”€â”€ Card Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('addCardForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const msg = document.getElementById('addCardMsg');
  const payload = {
    display_name: document.getElementById('newCardName').value.trim(),
    last4: document.getElementById('newCardLast4').value.trim() || null,
    network: document.getElementById('newCardNetwork').value.trim() || null,
  };
  if (!payload.display_name) { msg.textContent = 'âœ— Nickname is required.'; return; }
  try {
    const resp = await fetch('/cards', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
    });
    if (resp.ok) {
      const data = await resp.json();
      msg.className = 'mb-2 small text-success';
      msg.textContent = 'âœ“ Card added.';
      document.getElementById('newCardName').value = '';
      document.getElementById('newCardLast4').value = '';
      document.getElementById('newCardNetwork').value = '';
      addCardToList(data);
      updateCardCount(1);
    } else {
      const err = await resp.json();
      msg.className = 'mb-2 small text-danger';
      msg.textContent = 'âœ— ' + (err.detail || 'Add failed.');
    }
  } catch (ex) {
    msg.className = 'mb-2 small text-danger';
    msg.textContent = 'âœ— Request failed: ' + ex;
  }
});

function updateCardCount(delta) {
  const badge = document.getElementById('cardCountBadge');
  if (badge) {
    const m = badge.textContent.match(/\d+/);
    const n = m ? parseInt(m[0]) + delta : delta;
    badge.textContent = n + ' cards';
  }
}

function addCardToList(card) {
  const noMsg = document.getElementById('noCardsMsg');
  if (noMsg) noMsg.remove();
  const list = document.getElementById('cardsList');
  const div = document.createElement('div');
  div.className = 'card mb-2 card-entry';
  div.id = 'card-entry-' + card.id;
  const last4Html = card.last4 ? `<span class="text-muted ms-2">****${card.last4}</span>` : '';
  const netHtml = card.network ? `<span class="badge bg-light text-dark ms-2 small">${card.network}</span>` : '';
  div.innerHTML = `
    <div class="card-body py-2">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <strong id="card-name-${card.id}">${card.display_name}</strong>${last4Html}${netHtml}
        </div>
        <div class="d-flex gap-1">
          <button class="btn btn-outline-secondary btn-sm" onclick="toggleEditCard(${card.id})">âœï¸</button>
          <button class="btn btn-outline-danger btn-sm" onclick="deleteCard(${card.id})">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div id="edit-card-${card.id}" class="mt-2" style="display:none">
        <form onsubmit="saveCard(event, ${card.id})">
          <div class="row g-2 align-items-end">
            <div class="col"><input type="text" name="display_name" class="form-control form-control-sm" value="${card.display_name}" placeholder="Nickname" required></div>
            <div class="col-auto"><input type="text" name="last4" class="form-control form-control-sm" value="${card.last4 || ''}" placeholder="Last 4" maxlength="10"></div>
            <div class="col-auto"><input type="text" name="network" class="form-control form-control-sm" value="${card.network || ''}" placeholder="Network" maxlength="50"></div>
            <div class="col-auto">
              <button type="submit" class="btn btn-primary btn-sm">Save</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleEditCard(${card.id})">Cancel</button>
            </div>
          </div>
        </form>
      </div>
      <ul class="list-unstyled mb-0 ms-2" id="aliases-${card.id}"></ul>
      <div class="mt-2">
        <form onsubmit="addAlias(event, ${card.id})" class="d-flex gap-2 align-items-end">
          <input type="text" name="alias_last4" class="form-control form-control-sm" placeholder="Virtual last4" maxlength="10" pattern="\\d{4}" required style="width:120px">
          <input type="text" name="notes" class="form-control form-control-sm" placeholder="Notes (optional)" style="width:180px">
          <button type="submit" class="btn btn-outline-secondary btn-sm">+ Alias</button>
        </form>
      </div>
    </div>`;
  list.appendChild(div);
}

function toggleEditCard(cardId) {
  const el = document.getElementById('edit-card-' + cardId);
  if (el) el.style.display = el.style.display === 'none' ? '' : 'none';
}

async function saveCard(event, cardId) {
  event.preventDefault();
  const form = event.target;
  const payload = {
    display_name: form.display_name.value.trim(),
    last4: form.last4.value.trim() || null,
    network: form.network.value.trim() || null,
  };
  const resp = await fetch('/cards/' + cardId, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  if (resp.ok) {
    const data = await resp.json();
    const nameEl = document.getElementById('card-name-' + cardId);
    if (nameEl) nameEl.textContent = data.display_name;
    toggleEditCard(cardId);
  } else {
    const err = await resp.json();
    alert('âœ— ' + (err.detail || 'Save failed.'));
  }
}

async function deleteCard(cardId) {
  if (!confirm('Delete this card and all its aliases?')) return;
  const resp = await fetch('/cards/' + cardId, {method: 'DELETE'});
  if (resp.ok || resp.status === 204) {
    const el = document.getElementById('card-entry-' + cardId);
    if (el) el.remove();
    updateCardCount(-1);
  } else {
    alert('Failed to delete card.');
  }
}

async function addAlias(event, cardId) {
  event.preventDefault();
  const form = event.target;
  const payload = {
    alias_last4: form.alias_last4.value.trim(),
    notes: form.notes.value.trim() || null,
  };
  const resp = await fetch('/cards/' + cardId + '/aliases', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  if (resp.ok) {
    const data = await resp.json();
    const ul = document.getElementById('aliases-' + cardId);
    if (ul) {
      const li = document.createElement('li');
      li.className = 'd-flex align-items-center gap-2';
      li.id = 'alias-' + data.id;
      li.innerHTML = `<code>****${data.alias_last4}</code>` +
        (data.notes ? `<small class="text-muted">${data.notes}</small>` : '') +
        `<button class="btn btn-link btn-sm text-danger p-0" onclick="deleteAlias(${cardId}, ${data.id})">âœ•</button>`;
      ul.appendChild(li);
    }
    form.reset();
  } else {
    const err = await resp.json();
    alert('âœ— ' + (err.detail || 'Add alias failed.'));
  }
}

async function deleteAlias(cardId, aliasId) {
  const resp = await fetch('/cards/' + cardId + '/aliases/' + aliasId, {method: 'DELETE'});
  if (resp.ok || resp.status === 204) {
    const el = document.getElementById('alias-' + aliasId);
    if (el) el.remove();
  }
}
</script>
{% endblock %}
