{% extends "base.html" %}
{% block title %}Settings ‚Äî Email Receipts{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col">
    <h2>Google Integrations</h2>
    <p class="text-muted">Gmail and Google Drive may be connected to <strong>different</strong> Google accounts.</p>
  </div>
</div>

{% if accounts_differ %}
<div class="alert alert-info d-flex align-items-center" role="alert">
  <svg class="bi flex-shrink-0 me-2" width="20" height="20" fill="currentColor" aria-hidden="true">
    <use xlink:href="#info-circle-fill"/>
  </svg>
  <div>
    <strong>Informational:</strong> Gmail is connected as
    <strong>{{ gmail_conn.google_account_email }}</strong> and Drive as
    <strong>{{ drive_conn.google_account_email }}</strong>.
    This is intentional if you forward emails from one account and store files in another.
  </div>
</div>
{% endif %}

<div class="row g-4">

  <!-- Gmail Connection Card -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <span>üì¨</span>
        <strong>Gmail Connection</strong>
        {% if gmail_conn %}
          <span class="badge bg-success ms-auto">Connected</span>
        {% else %}
          <span class="badge bg-secondary ms-auto">Not connected</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if gmail_conn %}
          <p class="mb-1"><strong>Account:</strong> {{ gmail_conn.google_account_email or "Unknown" }}</p>
          <p class="mb-1 text-muted small">
            Connected: {{ gmail_conn.connected_at.strftime("%Y-%m-%d %H:%M UTC") if gmail_conn.connected_at else "‚Äî" }}
          </p>
          <p class="mb-0 text-muted small">
            Scopes: gmail.readonly, gmail.modify
          </p>
        {% else %}
          <p class="text-muted">No Gmail account connected. Connect one to start polling for new receipt emails.</p>
        {% endif %}
      </div>
      <div class="card-footer">
        <a href="/auth/google/gmail/start" class="btn btn-primary btn-sm">
          {% if gmail_conn %}üîÑ Reconnect Gmail{% else %}üîó Connect Gmail{% endif %}
        </a>
      </div>
    </div>
  </div>

  <!-- Drive Connection Card -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <span>üìÅ</span>
        <strong>Google Drive Connection</strong>
        {% if drive_conn %}
          <span class="badge bg-success ms-auto">Connected</span>
        {% else %}
          <span class="badge bg-secondary ms-auto">Not connected</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if drive_conn %}
          <p class="mb-1"><strong>Account:</strong> {{ drive_conn.google_account_email or "Unknown" }}</p>
          <p class="mb-1 text-muted small">
            Connected: {{ drive_conn.connected_at.strftime("%Y-%m-%d %H:%M UTC") if drive_conn.connected_at else "‚Äî" }}
          </p>
          <p class="mb-0 text-muted small">
            Scopes: drive.file
          </p>
        {% else %}
          <p class="text-muted">No Drive account connected. Receipts without a Drive connection will be placed in the needs-review queue.</p>
        {% endif %}
      </div>
      <div class="card-footer">
        <a href="/auth/google/drive/start" class="btn btn-primary btn-sm">
          {% if drive_conn %}üîÑ Reconnect Drive{% else %}üîó Connect Drive{% endif %}
        </a>
      </div>
    </div>
  </div>

</div>

<!-- Drive Folder Setting -->
<div class="row g-4 mt-2">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <span>üóÇÔ∏è</span>
        <strong>Google Drive Root Folder</strong>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-2">
          Receipts are saved under this folder in Google Drive. Subfolders are created automatically
          per card, year, and month.
        </p>
        <form id="driveFolderForm">
          <input type="hidden" id="driveFolderIdInput" value="{{ drive_root_folder_id }}" />
          <div class="input-group">
            <input
              type="text"
              id="driveFolderInput"
              class="form-control"
              value="{{ drive_root_folder }}"
              placeholder="e.g. Receipts"
              required
            />
            {% if drive_conn %}
            <button class="btn btn-outline-secondary" type="button" id="browseFolderBtn" title="Browse Drive folders">
              üìÇ Browse
            </button>
            {% endif %}
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
        <div id="driveFolderMsg" class="mt-2 small"></div>
      </div>
    </div>
  </div>
</div>

<!-- Drive Folder Browser Modal -->
<div class="modal fade" id="driveFolderModal" tabindex="-1" aria-labelledby="driveFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="driveFolderModalLabel">üìÇ Browse Google Drive Folders</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Breadcrumb navigation -->
        <nav aria-label="folder breadcrumb" class="mb-3">
          <ol class="breadcrumb" id="folderBreadcrumb">
            <li class="breadcrumb-item"><a href="#" data-folder-id="root" data-folder-name="My Drive">My Drive</a></li>
          </ol>
        </nav>
        <!-- Folder list -->
        <div id="folderListArea">
          <div class="text-center text-muted py-4" id="folderLoading">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading folders‚Ä¶
          </div>
          <ul class="list-group" id="folderList" style="display:none;"></ul>
          <p class="text-muted small mt-2" id="folderEmpty" style="display:none;">No subfolders found in this location.</p>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="small text-muted" id="selectedFolderLabel">No folder selected</div>
        <div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmFolderBtn" disabled>Select This Folder</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Allowed Senders -->
<div class="row g-4 mt-2">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <span>‚úâÔ∏è</span>
        <strong>Allowed Senders</strong>
        <span class="badge bg-secondary ms-auto">{{ allowed_senders|length }} configured</span>
      </div>
      <div class="card-body" id="sendersCardBody"> Emails from other senders will be
          <strong>archived</strong> (moved out of inbox) automatically.
          Leave this list empty to accept receipts from <em>any</em> sender.
        </p>

        <!-- Add sender form -->
        <form id="addSenderForm" class="mb-3">
          <div class="input-group">
            <input
              type="email"
              id="newSenderEmail"
              class="form-control"
              placeholder="receipts@store.com"
              required
            />
            <button class="btn btn-success" type="submit">Add</button>
          </div>
        </form>
        <div id="addSenderMsg" class="mb-2 small"></div>

        <!-- Existing senders list -->
        {% if allowed_senders %}
        <ul class="list-group" id="sendersList">
          {% for sender in allowed_senders %}
          <li class="list-group-item d-flex justify-content-between align-items-center" id="sender-{{ sender.id }}">
            <span>{{ sender.email }}</span>
            <button
              class="btn btn-outline-danger btn-sm"
              onclick="deleteSender({{ sender.id }})"
            >Remove</button>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small" id="noSendersMsg">No allowed senders configured ‚Äî all senders are accepted.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
// Drive folder form
document.getElementById('driveFolderForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const folder = document.getElementById('driveFolderInput').value.trim();
  const folderId = document.getElementById('driveFolderIdInput').value.trim();
  const msg = document.getElementById('driveFolderMsg');
  try {
    const resp = await fetch('/settings/app', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({drive_root_folder: folder, drive_root_folder_id: folderId}),
    });
    if (resp.ok) {
      const data = await resp.json();
      document.getElementById('driveFolderInput').value = data.drive_root_folder;
      document.getElementById('driveFolderIdInput').value = data.drive_root_folder_id;
      msg.className = 'mt-2 small text-success';
      msg.textContent = '‚úì Saved successfully.';
    } else {
      const err = await resp.json();
      msg.className = 'mt-2 small text-danger';
      msg.textContent = '‚úó ' + (err.detail || 'Save failed.');
    }
  } catch (ex) {
    msg.className = 'mt-2 small text-danger';
    msg.textContent = '‚úó Request failed: ' + ex;
  }
});

// ‚îÄ‚îÄ Drive Folder Browser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Stack of {id, name} representing the current navigation path
let driveFolderStack = [];
let driveFolderSelected = null; // {id, name}

function renderDriveFolderBreadcrumb() {
  const ol = document.getElementById('folderBreadcrumb');
  ol.innerHTML = '';
  // Root item
  const rootLi = document.createElement('li');
  rootLi.className = 'breadcrumb-item';
  if (driveFolderStack.length === 0) {
    rootLi.classList.add('active');
    rootLi.textContent = 'My Drive';
  } else {
    const a = document.createElement('a');
    a.href = '#';
    a.textContent = 'My Drive';
    a.addEventListener('click', function(e) { e.preventDefault(); navigateDriveFolder('root', 'My Drive', 0); });
    rootLi.appendChild(a);
  }
  ol.appendChild(rootLi);

  driveFolderStack.forEach(function(item, idx) {
    const li = document.createElement('li');
    li.className = 'breadcrumb-item';
    if (idx === driveFolderStack.length - 1) {
      li.classList.add('active');
      li.textContent = item.name;
    } else {
      const a = document.createElement('a');
      a.href = '#';
      a.textContent = item.name;
      const capturedIdx = idx + 1;
      a.addEventListener('click', function(e) {
        e.preventDefault();
        navigateDriveFolder(item.id, item.name, capturedIdx);
      });
      li.appendChild(a);
    }
    ol.appendChild(li);
  });
}

async function navigateDriveFolder(parentId, parentName, stackDepth) {
  // Trim stack to the chosen depth
  driveFolderStack = driveFolderStack.slice(0, stackDepth);
  renderDriveFolderBreadcrumb();
  await loadDriveFolders(parentId);
}

async function loadDriveFolders(parentId) {
  const loading = document.getElementById('folderLoading');
  const list = document.getElementById('folderList');
  const empty = document.getElementById('folderEmpty');
  loading.style.display = '';
  list.style.display = 'none';
  empty.style.display = 'none';
  list.innerHTML = '';

  try {
    const resp = await fetch('/settings/drive-folders?parent_id=' + encodeURIComponent(parentId));
    if (!resp.ok) {
      const err = await resp.json();
      loading.style.display = 'none';
      empty.style.display = '';
      empty.textContent = '‚úó ' + (err.detail || 'Failed to load folders.');
      return;
    }
    const data = await resp.json();
    loading.style.display = 'none';

    if (data.folders.length === 0) {
      empty.style.display = '';
      empty.textContent = 'No subfolders found in this location.';
      return;
    }

    data.folders.forEach(function(folder) {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';

      const nameBtn = document.createElement('button');
      nameBtn.className = 'btn btn-link p-0 text-start';
      nameBtn.innerHTML = 'üìÅ ' + folder.name + ' <small class="text-muted ms-1">‚Ä∫</small>';
      nameBtn.addEventListener('click', function() {
        driveFolderStack.push({id: folder.id, name: folder.name});
        navigateDriveFolder(folder.id, folder.name, driveFolderStack.length);
      });

      const selectBtn = document.createElement('button');
      selectBtn.className = 'btn btn-sm btn-outline-primary';
      selectBtn.textContent = 'Select';
      selectBtn.addEventListener('click', function() {
        driveFolderSelected = {id: folder.id, name: folder.name};
        const label = document.getElementById('selectedFolderLabel');
        label.innerHTML = 'üìÇ <strong>' + folder.name + '</strong> selected';
        document.getElementById('confirmFolderBtn').disabled = false;
      });

      li.appendChild(nameBtn);
      li.appendChild(selectBtn);
      list.appendChild(li);
    });
    list.style.display = '';
  } catch (ex) {
    loading.style.display = 'none';
    empty.style.display = '';
    empty.textContent = '‚úó Request failed: ' + ex;
  }
}

const browseFolderBtn = document.getElementById('browseFolderBtn');
if (browseFolderBtn) {
  browseFolderBtn.addEventListener('click', async function() {
    driveFolderStack = [];
    driveFolderSelected = null;
    document.getElementById('selectedFolderLabel').textContent = 'No folder selected';
    document.getElementById('confirmFolderBtn').disabled = true;
    renderDriveFolderBreadcrumb();
    const modal = new bootstrap.Modal(document.getElementById('driveFolderModal'));
    modal.show();
    await loadDriveFolders('root');
  });
}

document.getElementById('confirmFolderBtn').addEventListener('click', function() {
  if (!driveFolderSelected) return;
  document.getElementById('driveFolderInput').value = driveFolderSelected.name;
  document.getElementById('driveFolderIdInput').value = driveFolderSelected.id;
  bootstrap.Modal.getInstance(document.getElementById('driveFolderModal')).hide();
  document.getElementById('driveFolderMsg').className = 'mt-2 small text-info';
  document.getElementById('driveFolderMsg').textContent = 'üìÇ Folder selected ‚Äî click Save to apply.';
});

// Add allowed sender
document.getElementById('addSenderForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const email = document.getElementById('newSenderEmail').value.trim();
  const msg = document.getElementById('addSenderMsg');
  try {
    const resp = await fetch('/settings/allowed-senders', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email: email}),
    });
    if (resp.ok) {
      const data = await resp.json();
      document.getElementById('newSenderEmail').value = '';
      msg.className = 'mb-2 small text-success';
      msg.textContent = '‚úì Added ' + data.email;
      addSenderToList(data.id, data.email);
    } else {
      const err = await resp.json();
      msg.className = 'mb-2 small text-danger';
      msg.textContent = '‚úó ' + (err.detail || 'Add failed.');
    }
  } catch (ex) {
    msg.className = 'mb-2 small text-danger';
    msg.textContent = '‚úó Request failed: ' + ex;
  }
});

function addSenderToList(id, email) {
  const noMsg = document.getElementById('noSendersMsg');
  if (noMsg) noMsg.remove();

  let list = document.getElementById('sendersList');
  if (!list) {
    list = document.createElement('ul');
    list.className = 'list-group';
    list.id = 'sendersList';
    // Insert after addSenderMsg to maintain template layout order
    const msgEl = document.getElementById('addSenderMsg');
    msgEl.insertAdjacentElement('afterend', list);
  }
  const li = document.createElement('li');
  li.className = 'list-group-item d-flex justify-content-between align-items-center';
  li.id = 'sender-' + id;
  li.innerHTML = '<span>' + email + '</span>' +
    '<button class="btn btn-outline-danger btn-sm" onclick="deleteSender(' + id + ')">Remove</button>';
  list.appendChild(li);
}

async function deleteSender(id) {
  const resp = await fetch('/settings/allowed-senders/' + id, {method: 'DELETE'});
  if (resp.ok || resp.status === 204) {
    const el = document.getElementById('sender-' + id);
    if (el) el.remove();
    const list = document.getElementById('sendersList');
    if (list && list.children.length === 0) {
      list.remove();
      // Use the stable card-body id to append the 'no senders' message
      const cardBody = document.getElementById('sendersCardBody');
      const p = document.createElement('p');
      p.className = 'text-muted small';
      p.id = 'noSendersMsg';
      p.textContent = 'No allowed senders configured ‚Äî all senders are accepted.';
      cardBody.appendChild(p);
    }
  }
}
</script>
{% endblock %}
