{% extends "base.html" %}
{% block title %}Settings â€” Email Receipts{% endblock %}

{% block content %}
<!-- Google Picker API -->
<script src="https://apis.google.com/js/api.js" async defer></script>

<div class="row mb-3">
  <div class="col">
    <h2>Google Integrations</h2>
    <p class="text-muted">Gmail and Google Drive may be connected to <strong>different</strong> Google accounts.</p>
  </div>
</div>

{% if accounts_differ %}
<div class="alert alert-info d-flex align-items-center" role="alert">
  <svg class="bi flex-shrink-0 me-2" width="20" height="20" fill="currentColor" aria-hidden="true">
    <use xlink:href="#info-circle-fill"/>
  </svg>
  <div>
    <strong>Informational:</strong> Gmail is connected as
    <strong>{{ gmail_conn.google_account_email }}</strong> and Drive as
    <strong>{{ drive_conn.google_account_email }}</strong>.
    This is intentional if you forward emails from one account and store files in another.
  </div>
</div>
{% endif %}

<div class="row g-4">

  <!-- Gmail Connection Card -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ğŸ“¬</span>
        <strong>Gmail Connection</strong>
        {% if gmail_conn %}
          <span class="badge bg-success ms-auto">Connected</span>
        {% else %}
          <span class="badge bg-secondary ms-auto">Not connected</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if gmail_conn %}
          <p class="mb-1"><strong>Account:</strong> {{ gmail_conn.google_account_email or "Unknown" }}</p>
          <p class="mb-1 text-muted small">
            Connected: {{ gmail_conn.connected_at.strftime("%Y-%m-%d %H:%M UTC") if gmail_conn.connected_at else "â€”" }}
          </p>
          <p class="mb-0 text-muted small">
            Scopes: gmail.readonly, gmail.modify
          </p>
        {% else %}
          <p class="text-muted">No Gmail account connected. Connect one to start polling for new receipt emails.</p>
        {% endif %}
      </div>
      <div class="card-footer">
        <a href="/auth/google/gmail/start" class="btn btn-primary btn-sm">
          {% if gmail_conn %}ğŸ”„ Reconnect Gmail{% else %}ğŸ”— Connect Gmail{% endif %}
        </a>
      </div>
    </div>
  </div>

  <!-- Drive Connection Card -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ğŸ“</span>
        <strong>Google Drive Connection</strong>
        {% if drive_conn %}
          <span class="badge bg-success ms-auto">Connected</span>
        {% else %}
          <span class="badge bg-secondary ms-auto">Not connected</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if drive_conn %}
          <p class="mb-1"><strong>Account:</strong> {{ drive_conn.google_account_email or "Unknown" }}</p>
          <p class="mb-1 text-muted small">
            Connected: {{ drive_conn.connected_at.strftime("%Y-%m-%d %H:%M UTC") if drive_conn.connected_at else "â€”" }}
          </p>
          <p class="mb-0 text-muted small">
            Scopes: drive.file, drive.readonly
          </p>
        {% else %}
          <p class="text-muted">No Drive account connected. Receipts without a Drive connection will be placed in the needs-review queue.</p>
        {% endif %}
      </div>
      <div class="card-footer">
        <a href="/auth/google/drive/start" class="btn btn-primary btn-sm">
          {% if drive_conn %}ğŸ”„ Reconnect Drive{% else %}ğŸ”— Connect Drive{% endif %}
        </a>
      </div>
    </div>
  </div>

</div>

<!-- Drive Folder Setting -->
<div class="row g-4 mt-2">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <span>ğŸ—‚ï¸</span>
        <strong>Google Drive Root Folder</strong>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-2">
          Receipts are saved under this folder in Google Drive. Subfolders are created automatically
          per card, year, and month.
        </p>
        <form id="driveFolderForm">
          <input type="hidden" id="driveFolderIdInput" value="{{ drive_root_folder_id }}" />
          <div class="input-group">
            <input
              type="text"
              id="driveFolderInput"
              class="form-control"
              value="{{ drive_root_folder }}"
              placeholder="e.g. Receipts"
              required
            />
            {% if drive_conn %}
            <button class="btn btn-outline-secondary" type="button" id="browseFolderBtn" title="Browse Drive folders">
              ğŸ“‚ Browse
            </button>
            {% endif %}
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
        <div id="driveFolderMsg" class="mt-2 small"></div>
      </div>
    </div>
  </div>
</div>

<!-- Allowed Senders -->
<div class="row g-4 mt-2">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <span>âœ‰ï¸</span>
        <strong>Allowed Senders</strong>
        <span class="badge bg-secondary ms-auto">{{ allowed_senders|length }} configured</span>
      </div>
      <div class="card-body" id="sendersCardBody"> Emails from other senders will be
          <strong>archived</strong> (moved out of inbox) automatically.
          Leave this list empty to accept receipts from <em>any</em> sender.
        </p>

        <!-- Add sender form -->
        <form id="addSenderForm" class="mb-3">
          <div class="input-group">
            <input
              type="email"
              id="newSenderEmail"
              class="form-control"
              placeholder="receipts@store.com"
              required
            />
            <button class="btn btn-success" type="submit">Add</button>
          </div>
        </form>
        <div id="addSenderMsg" class="mb-2 small"></div>

        <!-- Existing senders list -->
        {% if allowed_senders %}
        <ul class="list-group" id="sendersList">
          {% for sender in allowed_senders %}
          <li class="list-group-item d-flex justify-content-between align-items-center" id="sender-{{ sender.id }}">
            <span>{{ sender.email }}</span>
            <button
              class="btn btn-outline-danger btn-sm"
              onclick="deleteSender({{ sender.id }})"
            >Remove</button>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small" id="noSendersMsg">No allowed senders configured â€” all senders are accepted.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
const googleApiKey = {{ google_api_key | tojson }};
const googleClientId = {{ google_client_id | tojson }};

// Drive folder form
document.getElementById('driveFolderForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const folder = document.getElementById('driveFolderInput').value.trim();
  const folderId = document.getElementById('driveFolderIdInput').value.trim();
  const msg = document.getElementById('driveFolderMsg');
  try {
    const resp = await fetch('/settings/app', {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({drive_root_folder: folder, drive_root_folder_id: folderId}),
    });
    if (resp.ok) {
      const data = await resp.json();
      document.getElementById('driveFolderInput').value = data.drive_root_folder;
      document.getElementById('driveFolderIdInput').value = data.drive_root_folder_id;
      msg.className = 'mt-2 small text-success';
      msg.textContent = 'âœ“ Saved successfully.';
    } else {
      const err = await resp.json();
      msg.className = 'mt-2 small text-danger';
      msg.textContent = 'âœ— ' + (err.detail || 'Save failed.');
    }
  } catch (ex) {
    msg.className = 'mt-2 small text-danger';
    msg.textContent = 'âœ— Request failed: ' + ex;
  }
});

// â”€â”€ Google Drive Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function drivePickerCallback(data) {
  if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
    const doc = data[google.picker.Response.DOCUMENTS][0];
    document.getElementById('driveFolderInput').value = doc[google.picker.Document.NAME];
    document.getElementById('driveFolderIdInput').value = doc[google.picker.Document.ID];
    const msg = document.getElementById('driveFolderMsg');
    msg.className = 'mt-2 small text-info';
    msg.textContent = 'ğŸ“‚ Folder selected â€” click Save to apply.';
  }
}

function openDrivePicker(accessToken) {
  gapi.load('picker', function() {
    const view = new google.picker.DocsView()
      .setIncludeFolders(true)
      .setSelectFolderEnabled(true)
      .setMimeTypes('application/vnd.google-apps.folder');

    const pickerBuilder = new google.picker.PickerBuilder()
      .addView(view)
      .setOAuthToken(accessToken)
      .setCallback(drivePickerCallback)
      .setTitle('Select a Google Drive folder for receipts');

    if (googleApiKey) {
      pickerBuilder.setDeveloperKey(googleApiKey);
    }

    pickerBuilder.build().setVisible(true);
  });
}

const browseFolderBtn = document.getElementById('browseFolderBtn');
if (browseFolderBtn) {
  browseFolderBtn.addEventListener('click', async function() {
    const msg = document.getElementById('driveFolderMsg');
    try {
      const resp = await fetch('/settings/drive-token');
      if (!resp.ok) {
        msg.className = 'mt-2 small text-danger';
        msg.textContent = 'âœ— Google Drive is not connected.';
        return;
      }
      const data = await resp.json();
      openDrivePicker(data.access_token);
    } catch (ex) {
      msg.className = 'mt-2 small text-danger';
      msg.textContent = 'âœ— Failed to open picker: ' + ex;
    }
  });
}

// Add allowed sender
document.getElementById('addSenderForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const email = document.getElementById('newSenderEmail').value.trim();
  const msg = document.getElementById('addSenderMsg');
  try {
    const resp = await fetch('/settings/allowed-senders', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email: email}),
    });
    if (resp.ok) {
      const data = await resp.json();
      document.getElementById('newSenderEmail').value = '';
      msg.className = 'mb-2 small text-success';
      msg.textContent = 'âœ“ Added ' + data.email;
      addSenderToList(data.id, data.email);
    } else {
      const err = await resp.json();
      msg.className = 'mb-2 small text-danger';
      msg.textContent = 'âœ— ' + (err.detail || 'Add failed.');
    }
  } catch (ex) {
    msg.className = 'mb-2 small text-danger';
    msg.textContent = 'âœ— Request failed: ' + ex;
  }
});

function addSenderToList(id, email) {
  const noMsg = document.getElementById('noSendersMsg');
  if (noMsg) noMsg.remove();

  let list = document.getElementById('sendersList');
  if (!list) {
    list = document.createElement('ul');
    list.className = 'list-group';
    list.id = 'sendersList';
    // Insert after addSenderMsg to maintain template layout order
    const msgEl = document.getElementById('addSenderMsg');
    msgEl.insertAdjacentElement('afterend', list);
  }
  const li = document.createElement('li');
  li.className = 'list-group-item d-flex justify-content-between align-items-center';
  li.id = 'sender-' + id;
  li.innerHTML = '<span>' + email + '</span>' +
    '<button class="btn btn-outline-danger btn-sm" onclick="deleteSender(' + id + ')">Remove</button>';
  list.appendChild(li);
}

async function deleteSender(id) {
  const resp = await fetch('/settings/allowed-senders/' + id, {method: 'DELETE'});
  if (resp.ok || resp.status === 204) {
    const el = document.getElementById('sender-' + id);
    if (el) el.remove();
    const list = document.getElementById('sendersList');
    if (list && list.children.length === 0) {
      list.remove();
      // Use the stable card-body id to append the 'no senders' message
      const cardBody = document.getElementById('sendersCardBody');
      const p = document.createElement('p');
      p.className = 'text-muted small';
      p.id = 'noSendersMsg';
      p.textContent = 'No allowed senders configured â€” all senders are accepted.';
      cardBody.appendChild(p);
    }
  }
}
</script>
{% endblock %}
